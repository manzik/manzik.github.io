<!DOCTYPE html>
<html>
<head>
    <title>text transfer by sound - get | Manzik lab</title>
    <script src="ascii-binary-converter.min.js"></script>
    <script src="dat.gui.min.js"></script>
    <script>
        //Audio stuff---------------------------------------------
        var contextClass = (window.AudioContext || window.webkitAudioContext);
        //get mic in
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
        navigator.getUserMedia(
        { audio: true },
        gotStream,
        function (err)
        {
            console.log("The following error occured: " + err);
        }
        );

        //for sound to be passed into
        var audioBuffer;
        //for analyser node
        var analyzer;
        //set empty array hald of fft size or equal to frequencybincount (you could put frequency bin count here if created)
        frequencyData = new Uint8Array(1024);
        if (contextClass)
        {
            // Web Audio API is available.
            var context = new contextClass();
        } else
        {
            // Web Audio API is not available. Ask the user to use a supported browser.
            alert("Oh nos! It appears your browser does not support the Web Audio API, please upgrade or use a different browser");
        }

        // success callback when requesting audio input stream
        function gotStream(stream)
        {
            createAnalyser()
            // Create an AudioNode from the stream.
            var mediaStreamSource = context.createMediaStreamSource(stream);
            connectAnalyser(mediaStreamSource)
            update();
        }

        function createAnalyser()
        {
            //create analyser node
            analyzer = context.createAnalyser();
            //set size of how many bits we analyse on
            analyzer.fftSize = 2048;
            analyzer.smoothingTimeConstant = 0;
        }

        function connectAnalyser(source)
        {
            //connect to source
            source.connect(analyzer);
        }

        function playSound()
        {
            //passing in file
            createAnalyser();
            //creating source node
            var source = context.createMediaElementSource(audioElement);
            connectAnalyser(source);
        }
        function u()
        {
            this.d = 1000;
        }
        window.onload = function ()
        {
            //c = document.getElementById("c");
            //ctx = c.getContext("2d");
            //c.height = innerHeight;
            //c.width = innerWidth;
            q = new u();
            var gui = new dat.GUI();

            c1 = gui.add(q, "d", 15, 2000).name("Speed(ms)");
            timing = q.d;
            c1.onFinishChange(function (v)
            {
                //if (localStorage)
                //    localStorage.setItem("triangles_5", v);
                //else
                //    window.localStorage.setItem("triangles_5", v);
                timing = v;
            });

        };
        listen = false;
        function update()
        {
            //ctx.clearRect(0, 0, innerWidth, innerHeight);


            analyzer.getByteFrequencyData(frequencyData);

            for (var i = 0; i < frequencyData.length; i++)
            {
                //ctx.beginPath();
                //ctx.moveTo(i+=0.5, innerHeight);
                //ctx.lineTo(i+0.5, innerHeight - frequencyData[i]*5);
                //ctx.stroke();
                //if (frequencyData[i] > 220) console.log(i);
            }
            if (!started && listen && frequencyData[139] > 200)
            {
                start();
                document.getElementById("bttn").innerHTML = "started";
                listen = false;
            }
            requestAnimationFrame(update);
        };
        listen = false;
        var n = 0, j = 0;
        var r = "";
        function obc()
        {
            listen = true;
            document.getElementById("bttn").innerHTML = "listening";
        }
        started = false;
        function start()
        {
            started = true;
            n = 0; j = 0;
            r = "";
            df = 0;
            harr = [];
            if (1)
            {
                setTimeout(function ()
                {
                    if (frequencyData[139] > 210)
                    {
                        r += "0";
                    }
                    else
                        r += "1";
                    n++;
                    si = setInterval(function ()
                    {
                        if (n != 8)
                        {
                            if (frequencyData[139] > 210)
                            {
                                r += "0";
                            }
                            else
                                r += "1";
                            n++;
                        }
                        else
                        {
                            if (frequencyData[139] > 210)
                            {
                                document.getElementById("ta").value = ABC.toAscii(r);
                                r += " ";
                                n = 0;
                                j++;
                            }
                            else
                            {
                                listen = false;
                                clearInterval(si);
                                started = false;
                                if (r != "")
                                {
                                    document.getElementById("ta").value = ABC.toAscii(r);
                                    document.getElementById("bttn").innerHTML = "done";
                                }
                                else
                                {
                                    document.getElementById("bttn").innerHTML = "error";
                                }
                                requestAnimationFrame(update);
                                setTimeout(function () { document.getElementById("bttn").innerHTML = "listen"; }, 2000);
                            }
                        }
                    }, timing);
                }, timing * 0.5);
            }
            else
            {
                harr[df] = frequencyData;
                df++;
                si = setInterval(function ()
                {
                    if (df < 8)
                    {
                        harr[df] = frequencyData;
                        df++;
                    }
                    else
                    {
                        listen = false;
                        clearInterval(si);
                        started = false;
                        document.getElementById("bttn").innerHTML = "done";
                        requestAnimationFrame(update);
                        setTimeout(function () { document.getElementById("bttn").innerHTML = "listen"; }, 2000);
                        for (var i = 0; i < 7; i++)
                        {
                            console.log(harr[i][139])
                        }
                    }
                }, timing);
            }


        }

    </script>
</head>

<body>
    <!--<canvas id="c">

     </canvas>-->
    <button id="bttn" onclick="obc()">listen</button><textarea id="ta"></textarea>
</body>
</html>