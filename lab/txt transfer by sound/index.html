<!DOCTYPE html>
<html>
<head>
    <title>text transfer by sound - get | Manzik lab</title>
    <script>
        //Audio stuff---------------------------------------------
        var contextClass = (window.AudioContext || window.webkitAudioContext);
        //get mic in
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
        navigator.getUserMedia(
        { audio: true },
        gotStream,
        function (err)
        {
            console.log("The following error occured: " + err);
        }
        );

        //for sound to be passed into
        var audioBuffer;
        //for analyser node
        var analyzer;
        //set empty array hald of fft size or equal to frequencybincount (you could put frequency bin count here if created)
        frequencyData = new Uint8Array(1024);
        if (contextClass)
        {
            // Web Audio API is available.
            var context = new contextClass();
        } else
        {
            // Web Audio API is not available. Ask the user to use a supported browser.
            alert("Oh nos! It appears your browser does not support the Web Audio API, please upgrade or use a different browser");
        }

        // success callback when requesting audio input stream
        function gotStream(stream)
        {
            createAnalyser()
            // Create an AudioNode from the stream.
            var mediaStreamSource = context.createMediaStreamSource(stream);
            connectAnalyser(mediaStreamSource)
            update();
        }

        function createAnalyser()
        {
            //create analyser node
            analyzer = context.createAnalyser();
            //set size of how many bits we analyse on
            analyzer.fftSize = 2048;
            analyzer.smoothingTimeConstant = 0;
        }

        function connectAnalyser(source)
        {
            //connect to source
            source.connect(analyzer);
        }

        function playSound()
        {
            //passing in file
            createAnalyser();
            //creating source node
            var source = context.createMediaElementSource(audioElement);
            connectAnalyser(source);
        }
        window.onload = function ()
        {
            c = document.getElementById("c");
            ctx = c.getContext("2d");
            c.height = innerHeight;
            c.width = innerWidth;
        };
        listen = false;
        timing = 1000;
        function update()
        {
            requestAnimationFrame(update);

            analyzer.getByteFrequencyData(frequencyData);
            var g = 0;
            for (var i = 0; i < frequencyData.length; i++)
            {
                if (frequencyData[i] > g)
                    g = frequencyData[i];
            }
            ta.innerHTML = String(g);
            document.getElementById("ta2").innerHTML = " frequencyData[139] =   " + frequencyData[139] + "      > 210"
           
            //if (frequencyData[139] > 200 && !started&&listen)
            //{
            //    start();
            //    document.getElementById("bttn").innerHTML = "started";
            //    listen = false;
            //}
        };
        listen = false;
        var n = 0, j = 0;
        var r = "";
        function obc()
        {
            listen = true;
            document.getElementById("bttn").innerHTML = "listening";
        }
        started = false;
        function start()
        {
            started = true;
            n = 0;j = 0;
            r = "";
            setTimeout(function ()
            {
                if (frequencyData[139] > 210)
                {
                    r += "0";
                }
                else
                    r += "1";
                n++;
                si = setInterval(function ()
                {
                    if (n!=8)
                    {
                        if (frequencyData[139] > 210)
                        {
                            r += "0";
                        }
                        else
                            r += "1";
                        n++;
                    }
                    else
                    {
                        if (frequencyData[139] > 210)
                        {
                            r += " ";
                            n = 0;
                            j++;
                        }
                        else
                        {
                            listen = false;
                            clearInterval(si);
                            started = false;
                            document.getElementById("ta").value = ABC.toAscii(r);
                            document.getElementById("bttn").innerHTML = "done";
                            setTimeout(function () { document.getElementById("bttn").innerHTML = "listen"; }, 2000);
                        }
                    }
                }, timing);
            }, timing*0.5);
                
            

        }
    </script>
</head>

<body>
    <textarea id="ta"></textarea><textarea id="ta2"></textarea>
</body>
</html>